# basic variables, hack rpath for /nexopia runtime
PREFIX = @prefix@
CC = @CC@
INSTALL = $(shell which install)
CFLAGS = @CFLAGS@

# we use thread safe version of library
MYSQL_CFLAGS = -I$(PREFIX)/include
MYSQL_LDFLAGS = -L@LIBMYSQLDIR@ -lmysqlclient_r @RPATH@

# hack for local access
GEARMAN_CFLAGS = $(shell PKG_CONFIG_PATH=$(PREFIX)/lib/pkgconfig pkg-config gearmand --cflags)
GEARMAN_LDFLAGS = $(shell PKG_CONFIG_PATH=$(PREFIX)/lib/pkgconfig pkg-config gearmand --libs)

SOURCE = dispatcher.c
HEADER = dispatcher.h
OBJECT = dispatcher.o

# setup final compiler flags
CFLAGS_REAL = $(DEFINES) $(CFLAGS) $(MYSQL_CFLAGS) $(GEARMAN_CFLAGS)
LDFLAGS_REAL = $(LDFLAGS) $(MYSQL_LDFLAGS) $(GEARMAN_LDFLAGS)

all: dispatcher

$(OBJECT): $(SOURCE) $(HEADER)
	$(CC) $(CFLAGS_REAL) -c $*.c -o $*.o

dispatcher: $(OBJECT)
	$(CC) $(OBJECT) $(LDFLAGS_REAL) -o dispatcher

clean:
	rm -f $(OBJECT) dispatcher
	
distclean: clean
	rm -f config.log config.status config.h configure Makefile
	rm -rf autom4te.cache .deps

install:
	$(INSTALL) -m 755 dispatcher $(PREFIX)/bin

.PHONY: all clean distclean install
